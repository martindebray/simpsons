<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Simpsons Museum</title>

    <link href="css/style.css" rel="stylesheet">

  </head>

  <body>
    <header id="menu">
      <nav>
        <ul>
          <li><a id="audience" href="#/audience">User Reviews</a></li><!--      
          --><li><a id="characters" href="#/characters">Characters</a></li><!--
          --><li><a id="home" href="#"><img src="img/donuts.svg" /></a></li><!--
          --><li><a id="facts" href="#/facts">Facts</a></li><!--
          --><li><a id="contribute" href="#/contribute">Contribute</a></li><!--
        --></ul>
      </nav>
    </header>

    <section id="content">
  
    </section>


  <!-- === Références aux Frameworks === -->
  <script src="libs/jquery.js"></script><!--V 1.10.2 -->
  <script src="libs/underscore.js"></script><!--V 1.5.2 -->
  <script src="libs/backbone.js"></script><!--V 1.1.0 --> 
  <script src="libs/d3.min.js" charset="utf-8"></script>



<!-- // var friends = new Backbone.Collection([
//   {name: "Athos",      job: "Musketeer"},
//   {name: "Porthos",    job: "Musketeer"},
//   {name: "Aramis",     job: "Musketeer"},
//   {name: "d'Artagnan", job: "Guard"},
// ]);

// console.log(friends);

// Templates  -->

<script type="text/template" id="home-template">
<h1>Home page</h1>
<p> Bonjour je suis un template</p>
</script>
<script type="text/template" id="audience-template">
<h1>User Reviews</h1>
<p>select a season</p>
</script>
<script type="text/template" id="characters-template">
<h1>Character appearances</h1>
<div id="characters-list"><h1>Choose a character</h1></div>
<a href="characters-list" id="open-list">List</a>
<div id="character-info">
  <div id="character-name"></div>
  <div id="character-catchphrase">Catchphrase<br><span></span></div>
  <div id="character-app-number">Appears in<br><span><span></span> episodes</span></div>
  <div id="character-first-app">First appeared in<br><span></span></div>
</div>
</script>
<script type="text/template" id="facts-template">
<h1>Funny Facts</h1>
<p>select a season</p>
</script>
<script type="text/template" id="contribute-template">
<h1>Give us data</h1>

</script>

<script>

  // Views

  var Home = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#home-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#home').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#facts').removeClass('selected');$('#contribute').removeClass('selected');

      }
  });

  var Audience = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#audience-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#audience').addClass('selected');
        $('#facts').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');
      }
  });

  var Characters = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#characters-template').html(),{}); // {} = données à parser pas besoin ici)
        this.$el.html(template);
        $('#characters').addClass('selected');
        $('#audience').removeClass('selected');$('#facts').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');

          // -----------------------------List of the characters -----------------------------
          
          $.getJSON( "json/characters.json", function( data ) {
            for(var i=0; i<data.length; i++){
              $("#characters-list").append('<a href="'+data[i].name+'" class="change-character" data-character="'+data[i].name+'"><img src="img/characters/'+data[i].name+'.svg" /><br>'+data[i].name+'</a>');
            }
          });

          $("#open-list").click(function(e){
            e.preventDefault();
            $("#characters-list").toggleClass("list-opened");
          })

          // ----------------------------------D3---------------------------------------------
          var ep_data; // a global variable for the data of all episode of all seasons
          var character_data; // a global variable for the data of all episode of all seasons
          var index = 0;
          var g;
          var svg;
          var img;

          // get episode data
          d3.json("json/episodes.json", function(error, json) {
            if (error) return console.warn(error);
            ep_data = json;
            visualizeit();
          });

          // get character data
          d3.json("json/characters.json", function(error, json) {
            if (error) return console.warn(error);
            character_data = json;
            displayInformation(index);
          });

          // display the character's information
          function displayInformation(index) {
            $("#character-name").text(character_data[index].name);
            $("#character-catchphrase span").text(character_data[index].name);
            $("#character-app-number span span").text(character_data[index].appearances.length);
            firstApp(character_data[index].appearances[0]);
          }

          
          // find the episode by its number
          function firstApp(i) {
            i = i-1;
            var title ="";
            $.getJSON( "json/episodes.json", function( data ) {
              for (var a=0; a<data.seasons.length; a++) {
                for (var j=0; j<data.seasons[a].length; j++) {
                    if (i == data.seasons[a][j].number){
                      $("#character-first-app span").text(data.seasons[a][i].title);
                    }
                }
              }
            });
          }

          // display all the episodes on the graph
          function visualizeit(){
            
            //create svg container
            svg = d3.select("#content").append("svg:svg")
                .attr("width", "80%")
                .attr("height", "60%")
                .append("svg:g")
                .attr("transform", "translate(550, 420)");
           
            // bars (rays) attributes
            var barSpacing = d3.scale.linear().domain([0, 9]).range([80, 170]); // domain = à peu près espacement des points &&& range = en gros le rayon de l'intérieur de l'arc                            
            var rotation = d3.range(183, 363, 7.2); // rotation rayon par rayon de l'angle 183 à 363 avec un pas de 7,2 (= 180 / 25 rayons)

            //add character's image
            img = svg.append("image")
              .attr("width", 310)
              .attr("height", 310)
              .attr("x", -155)
              .attr("y", -155)
              .attr("xlink:href","img/characters/"+character_data[0].name+".svg");

            // create a ray per season
            g = svg.selectAll("g")
                .data(ep_data.seasons)
                .enter().append("svg:g")
                .attr("transform", function(d,i) { return "rotate(" + rotation[i] + ")"; });

            // create dots for each episode on the rays
            var circle = g.selectAll("circle")
                .data(function(d, i, j) { return d; }) // on attache les données des apparitions par ep
                .enter().append("svg:circle")
                .attr("cx", function (d,i){return barSpacing(i); } ) 
                .attr("r", function (d,j){ if(checkAppearances(d,j)==true){ return 4.5 } else { return 2.5 } }) 
                .attr("fill", function (d,j) { if(checkAppearances(d,j)==true){ return "red" } else { return "#777" } }) 
                .on("mouseover", function (d,i){ return tooltip.style("visibility", "visible").text("Episode "+d.episode+" : "+d.title); }) //show label and title episode
                .on("mousemove", function (){ return tooltip.style("top",
                    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px"); })
                .on("mouseout", function (){ return tooltip.style("visibility", "hidden"); }); 
                

            // label the different rays with season number
            var text = g.append("svg:text");
            var textLabels = text
                          .attr("x", 330)
                          .attr("y", 0)
                          .text(function(d,i){return "Season "+ (i+1)})
                          .attr("font-family", "sans-serif")
                          .attr("font-size", "12px")
                          .attr("fill", "red");

            // the label that is displaying the title of an episode when the mouse is over a dot (episode)
            var tooltip = d3.select("body")
              .append("div")
              .style("position", "absolute")
              .style("z-index", "10")
              .style("background-color", "rgba(255,255,255,0.8)")
              .style("padding", "5px 10px")
              .style("font-size","12px")
              .style("font-family","arial")
              .style("visibility", "hidden");


          } //end visualizeit

          function checkAppearances(d,j) { 
            for (var i=0; i<(character_data[index].appearances).length; i++){
              if(d.number==character_data[index].appearances[i]){ 
                return true;
              } 
            }
          }

          function findIndexOf(json, name){
            for (var i=0; i<json.length; i++){
              if(json[i].name== name){
                return i;
              }
            } 
          }

          //Update the data on the graph
          $("#content").on("click","a.change-character",function () {
            $("#characters-list").toggleClass("list-opened");
            event.preventDefault();
            var selected = $(this).attr('data-character');
            console.log(selected);

            index = findIndexOf(character_data, selected);
            displayInformation(index);

            circle = g.selectAll("circle")
                .data(function(d, i, j) { return d; }) // on attache les données des apparitions par ep
                .transition().duration(750)
                .delay(100)
                .attr("r", function (d,j){ if(checkAppearances(d,j)==true){ return 4.5 } else { return 2.5 } }) 
                .attr("fill", function (d,j) { if(checkAppearances(d,j)==true){ return "red" } else { return "#777" } }) ;

            img = svg.selectAll("image")
              .data(character_data[0].name)
              .transition().duration(750)
              .delay(100)
              .attr("xlink:href","img/characters/"+selected+".svg");

          });


        // --------------------------FIN D3 --------------------------------------------
      }
  });

  var Facts = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#facts-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#facts').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');
      }
  });

  var Contribute = Backbone.View.extend({
      el:'#content',
      render: function(){
        // this.$el.html('Give us data');
        // Version Template
        var template = _.template($('#contribute-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#contribute').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#facts').removeClass('selected');
      }
  });

  // Créatin des Views

  var HomeView =  new Home();
  var AudienceView =  new Audience();
  var CharactersView =  new Characters(); 
  var FactsView =  new Facts();
  var ContributeView =  new Contribute();

  // Routeur

    var Router = Backbone.Router.extend({
      routes:{
        '':'home', // la home
        'audience': 'audience', // #audience 
        'audience/:season': 'audience/season', // #audience/season
        'characters':'characters', // #characters   
        'characters/:name':'characters/name', // #characters/name
        'facts':'facts', // #facts 
        'contribute':'contribute' // #contribute      
      }
    });

    var router = new Router(); // création d'un routeur

    router.on('route:home', function(){ // effets home page
      // déclencheur de l'action
      HomeView.render();
      console.log("On est sur la home page");
    });

    router.on('route:audience', function(){ // effets audience page
      // déclencheur de l'action
      AudienceView.render();
      console.log("On est sur la audience page de toutes les saisons");
    });

    router.on('route:audience/seasons', function(season){ // effets audience page
      // déclencheur de l'action
      console.log("On est sur la audience page seasons numero "+season);
    });

    router.on('route:characters', function(){ // effets characters page
      // déclencheur de l'action
      CharactersView.render();
      console.log("On est sur la page de tous les personnages");
    });

    router.on('route:characters/name', function(name){ // effets characters page
      // déclencheur de l'action
      console.log("On est sur la page character de "+name);
    });

    router.on('route:facts', function(){ // effets facts page
      // déclencheur de l'action
      FactsView.render();
      console.log("On est sur la facts page");
    });

    router.on('route:contribute', function(){ // effets contribute page
      // déclencheur de l'action
      ContributeView.render();
      console.log("On est sur la contribute page");
    });

    Backbone.history.start();






  </script>
  </body>
</html>


