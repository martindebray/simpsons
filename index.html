<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Simpsons Museum</title>

    <link href="css/style.css" rel="stylesheet">

  </head>

  <body>
    <menu id="menu">
      <nav>
        <ul>
          <li><a id="audience" href="#/audience">User Reviews</a></li>          
          <li><a id="characters" href="#/characters">Characters</a></li>
          <li><a id="home" href="#"><img src="img/donuts.svg" /></a></li>
          <li><a id="facts" href="#/facts">Facts</a></li>
          <li><a id="contribute" href="#/contribute">Contribute</a></li>
        </ul>
      </nav>
    </menu>

    <section id="content">
  
    </section>


  <!-- === Références aux Frameworks === -->
  <script src="libs/jquery.js"></script><!--V 1.10.2 -->
  <script src="libs/underscore.js"></script><!--V 1.5.2 -->
  <script src="libs/backbone.js"></script><!--V 1.1.0 --> 
  <script src="libs/d3.min.js" charset="utf-8"></script>



<!-- // var friends = new Backbone.Collection([
//   {name: "Athos",      job: "Musketeer"},
//   {name: "Porthos",    job: "Musketeer"},
//   {name: "Aramis",     job: "Musketeer"},
//   {name: "d'Artagnan", job: "Guard"},
// ]);

// console.log(friends);

// Templates  -->

<script type="text/template" id="home-template">
<h1>Home page</h1>
<p> Bonjour je suis un template</p>
</script>
<script type="text/template" id="audience-template">
<h1>User Reviews</h1>
<p>select a season</p>
</script>
<script type="text/template" id="characters-template">
<h1>Characters template</h1>
<input class="change-character" name="updateButton" type="button" value="Homer" />
<input class="change-character" name="updateButton" type="button" value="Marge" />
</script>
<script type="text/template" id="facts-template">
<h1>Funny Facts</h1>
<p>select a season</p>
</script>
<script type="text/template" id="contribute-template">
<h1>Give us data</h1>

</script>

<script>

  // Views

  var Home = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#home-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#home').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#facts').removeClass('selected');$('#contribute').removeClass('selected');

      }
  });

  var Audience = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#audience-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#audience').addClass('selected');
        $('#facts').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');
      }
  });

  var Characters = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#characters-template').html(),{}); // {} = données à parser pas besoin ici)
        this.$el.html(template);
        $('#characters').addClass('selected');
        $('#audience').removeClass('selected');$('#facts').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');
          // ----------------------------------D3---------------------------------------------
          var ep_data; // a global variable for the data of all episode of all seasons

          // get episode data
          d3.json("json/episodes.json", function(error, json) {
            if (error) return console.warn(error);
            ep_data = json;
            visualizeit();
          });


          var caracter_data; // a global variable for the data of all episode of all seasons

          // get caracter data
          d3.json("json/caracters.json", function(error, json) {
            if (error) return console.warn(error);
            caracter_data = json;
          });

          var index= 0;

        // display all the episodes on the graph
        function visualizeit(){

          //create svg container
          var svg = d3.select("#content").append("svg:svg")
              .attr("width", 1100)
              .attr("height", 550)
              .append("svg:g")
              .attr("transform", "translate(550, 550)");
         
          // bars (rays) attributes
          var barSpacing = d3.scale.linear().domain([0, 5]).range([180, 240]); // domain = à peu près espacement des points &&& range = en gros le rayon de l'intérieur de l'arc                            
          var rotation = d3.range(183, 363, 7.2); // rotation rayon par rayon de l'angle 183 à 363 avec un pas de 7,2 (= 180 / 25 rayons)

          // create a ray per season
          var g = svg.selectAll("g")
              .data(ep_data.seasons)
              .enter().append("svg:g")
              .attr("transform", function(d,i) { return "rotate(" + rotation[i] + ")"; });

          // create dots for each episode on the rays
          var circle = g.selectAll("circle")
              .data(function(d, i, j) { return d; }) // on attache les données des apparitions par ep
              .enter().append("svg:circle")
              .attr("cx", function(d,i){return barSpacing(i); } ) 
              .attr("r", function (d,j) { return 4.5 }) //if(d==0){ return 2.5 } else { return 4.5 }
              .attr("fill", function (d,j) { return "red" }) //if(d==0){ return "black" } else { return "red" }
              .on("mouseover", function(d, i){return tooltip.style("visibility", "visible").text(d.title);}) //show label and title episode
              .on("mousemove", function(){return tooltip.style("top",
                  (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
              .on("mouseout", function(){return tooltip.style("visibility", "hidden");}); 
              ;

          // label the different rays with season number
          var text = g.append("svg:text");
          var textLabels = text
                        .attr("x", 470)
                        .attr("y", 0)
                        .text(function(d,i){return "Season "+ (i+1)})
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "14px")
                        .attr("fill", "red");

          // the label that is displaying the title of an episode when the mouse is over a dot (episode)
          var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("background-color", "#fff")
            .style("padding", "2px 5px")
            .style("visibility", "hidden");;

        } //end visualizeit


          function findIndexOf(json, name){
          
            for (var i=0; i<json.length; i++){
              if(json[i].name== name){
                return i;
              }
            } 

          }


          $('input:button').click(updateData);



          function updateData() {

              var selected = $(this).attr('value');
              console.log(selected);

              index = findIndexOf(caracter_data, selected);
              console.log(index);

            //   var circle = svg.selectAll("svg g").data(map.get(selected))
            //      .selectAll("circle")
              //    .data(function(d, i, j) { return d; });

              // var delay = function(d, i) { return i * 50; };

            //   circle.transition().duration(750)
            //       .delay(delay)
            //       .attr("r", function (d,j) { if(d==0){ return 3 } else { return 4.5 } }) //4.5
              //    .attr("fill", function (d,j) { if(d==0){ return "black" } else { return "red" } });
          }



        // --------------------------FIN D3 --------------------------------------------
      }
  });

  var Facts = Backbone.View.extend({
      el:'#content',
      render: function(){
        var template = _.template($('#facts-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#facts').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#contribute').removeClass('selected');
      }
  });

  var Contribute = Backbone.View.extend({
      el:'#content',
      render: function(){
        // this.$el.html('Give us data');
        // Version Template
        var template = _.template($('#contribute-template').html(),{}); // {} = données à parser (pas besoin ici)
        this.$el.html(template);
        $('#contribute').addClass('selected');
        $('#audience').removeClass('selected');$('#characters').removeClass('selected');$('#home').removeClass('selected');$('#facts').removeClass('selected');
      }
  });

  // Créatin des Views

  var HomeView =  new Home();
  var AudienceView =  new Audience();
  var CharactersView =  new Characters(); 
  var FactsView =  new Facts();
  var ContributeView =  new Contribute();

  // Routeur

    var Router = Backbone.Router.extend({
      routes:{
        '':'home', // la home
        'audience': 'audience', // #audience 
        'audience/:season': 'audience/season', // #audience/season
        'characters':'characters', // #characters   
        'characters/:name':'characters/name', // #characters/name
        'facts':'facts', // #facts 
        'contribute':'contribute' // #contribute      
      }
    });

    var router = new Router(); // création d'un routeur

    router.on('route:home', function(){ // effets home page
      // déclencheur de l'action
      HomeView.render();
      console.log("On est sur la home page");
    });

    router.on('route:audience', function(){ // effets audience page
      // déclencheur de l'action
      AudienceView.render();
      console.log("On est sur la audience page de toutes les saisons");
    });

    router.on('route:audience/seasons', function(season){ // effets audience page
      // déclencheur de l'action
      console.log("On est sur la audience page seasons numero "+season);
    });

    router.on('route:characters', function(){ // effets characters page
      // déclencheur de l'action
      CharactersView.render();
      console.log("On est sur la page de tous les personnages");
    });

    router.on('route:characters/name', function(name){ // effets characters page
      // déclencheur de l'action
      console.log("On est sur la page character de "+name);
    });

    router.on('route:facts', function(){ // effets facts page
      // déclencheur de l'action
      FactsView.render();
      console.log("On est sur la facts page");
    });

    router.on('route:contribute', function(){ // effets contribute page
      // déclencheur de l'action
      ContributeView.render();
      console.log("On est sur la contribute page");
    });

    Backbone.history.start();






  </script>
  </body>
</html>


